mailster=function(e,o,t,a){"use strict";var n;e.optionbar={};e.optionbar.undos=[];e.optionbar.currentUndo=0;e.optionbar.undo=function(){if(e.optionbar.currentUndo){e.optionbar.currentUndo--;e.editor.setContent(e.optionbar.undos[e.optionbar.currentUndo],100,false);e.$.optionbar.find("a.redo").removeClass("disabled");if(!e.optionbar.currentUndo){o(this).addClass("disabled")}}};e.optionbar.redo=function(){var t=e.optionbar.undos.length;if(e.optionbar.currentUndo<t-1){e.optionbar.currentUndo++;e.editor.setContent(e.optionbar.undos[e.optionbar.currentUndo],100,false);e.$.optionbar.find("a.undo").removeClass("disabled");if(e.optionbar.currentUndo>=t-1){o(this).addClass("disabled")}}};e.optionbar.removeModules=function(){if(confirm(e.l10n.campaigns.remove_all_modules)){var o=e.$.iframe.contents().find("modules");var t=o.find("module");o.slideUp(function(){t.remove();o.html("").show();e.trigger("refresh");e.trigger("save")})}};e.optionbar.codeView=function(){var a;if(e.$.iframe.is(":visible")){a=e.editor.getStructure(e.editor.getFrameContent());e.$.optionbar.find("a.code").addClass("loading");e.trigger("disable");e.util.ajax("toggle_codeview",{bodyattributes:a.parts[2],content:a.content,head:a.head},function(o){e.$.optionbar.find("a.code").addClass("active").removeClass("loading");e.$.html.hide();e.$.content.val(o.data.content);if(wp.codeEditor){n=wp.codeEditor.initialize(e.$.content,{codemirror:e.util.codemirrorargs})}else{n={codemirror:t.CodeMirror.fromTextArea(e.$.content.get(0),e.util.codemirrorargs)}}e.$.optionbar.find("a").not("a.redo, a.undo, a.code").addClass("disabled")},function(o,t,a){e.$.optionbar.find("a.code").addClass("active").removeClass("loading");e.trigger("enable")})}else{a=e.editor.getStructure(n.codemirror.getValue());n.codemirror.clearHistory();e.$.optionbar.find("a.code").addClass("loading");e.trigger("disable");e.util.ajax("toggle_codeview",{bodyattributes:a.parts[2],content:a.content,head:a.head},function(t){e.editor.setContent(t.data.content,100,true,t.data.style);e.$.html.show();e.$.content.hide();o(".CodeMirror").remove();e.$.optionbar.find("a.code").removeClass("active").removeClass("loading");e.$.optionbar.find("a").not("a.redo, a.undo, a.code").removeClass("disabled");e.trigger("enable")},function(o,t,a){e.$.optionbar.find("a.code").addClass("active").removeClass("loading");e.trigger("enable")})}return false};e.optionbar.plainText=function(){if(e.$.iframe.is(":visible")){e.$.optionbar.find("a.plaintext").addClass("active");e.$.html.hide();e.$.excerpt.show();e.$.plaintext.show();e.$.optionbar.find("a").not("a.redo, a.undo, a.plaintext, a.precheck").addClass("disabled")}else{e.$.html.show();e.$.plaintext.hide();e.$.optionbar.find("a.plaintext").removeClass("active");e.$.optionbar.find("a").not("a.redo, a.undo, a.plaintext, a.precheck").removeClass("disabled");e.trigger("refresh")}};e.optionbar.openSaveDialog=function(){e.util.tb_show(e.l10n.campaigns.save_template,"#TB_inline?x=1&width=480&height=320&inlineId=mailster_template_save",null);o("#new_template_name").focus().select()};e.optionbar.precheck=function(){if(e.$.optionbar.find("a.precheck").is(".loading")){return false}e.$.optionbar.find("a.precheck").addClass("loading");e.precheck.open(function(){e.$.optionbar.find("a.precheck").removeClass("loading")});return};e.optionbar.dfw=function(o){if(o.type=="mouseout"&&!/DIV|H3/.test(o.target.nodeName)){return}if(!e.$.body.hasClass("focus-on")){e.$.body.removeClass("focus-off").addClass("focus-on");e.$.wpbody.on("mouseleave.dfw",e.optionbar.dfw);e.$.optionbar.find("a.dfw").addClass("active");if(e.$.window.scrollTop()<i()){e.util.scroll(i()-80)}}else{e.$.body.removeClass("focus-on").addClass("focus-off");e.$.wpbody.off("mouseleave",e.optionbar.dfw);e.$.optionbar.find("a.dfw").removeClass("active")}};e.editable&&e.$.document.on("click","button.save-template",s).on("click","button.save-template-cancel",tb_remove);e.editable&&e.$.optionbar.on("click","a",false).on("click","a.save-template",e.optionbar.openSaveDialog).on("click","a.clear-modules",e.optionbar.removeModules).on("click","a.precheck",e.optionbar.precheck).on("click","a.undo",e.optionbar.undo).on("click","a.redo",e.optionbar.redo).on("click","a.code",e.optionbar.codeView).on("click","a.plaintext",e.optionbar.plainText).on("click","a.dfw",e.optionbar.dfw).on("click","a.template",d).on("click","a.file",l);e.editable&&e.$.window.on("scroll.optionbar",r).on("resize.optionbar",function(){e.$.window.trigger("scroll.optionbar")});e.editable&&e.events.push("editorLoaded",function(){e.optionbar.undos.push(e.editor.getFrameContent())});o(".meta-box-sortables").on("sortstop",function(o,t){e.$.window.trigger("resize.optionbar")});function i(){if(!e.dom.template)return 0;return e.$.template.offset().top}function r(){var o=e.util.top();if(o<i()||o>i()+e.$.template.height()-0){if(e.dom.body&&/fixed-optionbar/.test(e.dom.body.className)){e.$.body.removeClass("fixed-optionbar");e.$.optionbar.width("auto")}}else{if(e.dom.body&&!/fixed-optionbar/.test(e.dom.body.className)){e.$.body.addClass("fixed-optionbar");e.$.optionbar.width(e.$.template.width()-22)}}}function d(e){var t=o(this);t.parent().find("ul").eq(0).slideToggle(100)}function l(){t.onbeforeunload=null;t.location=this.href}function s(){e.trigger("disable");var a=o("#new_template_name").val();if(!a){return false}e.trigger("save");var n=o("#new_template-ajax-loading").css("display","inline"),i=o("#new_template_modules").is(":checked"),r=o("#new_template_active_modules").is(":checked"),d=o("#new_template_saveas_dropdown").val(),l=!!parseInt(o('input[name="new_template_overwrite"]:checked').val(),10),s=e.editor.getContent();e.util.ajax("create_new_template",{name:a,modules:i,activemodules:r,overwrite:l?d:false,template:o("#mailster_template_name").val(),content:s,head:e.$.head.val()},function(e){n.hide();if(e.success){if(t.wp){t.wp=null}t.onbeforeunload=null;t.location=e.data.url}else{alert(e.data.msg)}},function(e,o,t){n.hide()});return false}return e}(mailster||{},jQuery,window,document);