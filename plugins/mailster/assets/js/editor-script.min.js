if(parent.window===window){var campaign_id;if(campaign_id=location.search.match(/id=(\d+)/i)[1]){window.location=location.protocol+"//"+location.host+location.pathname.replace("admin-ajax.php","post.php")+"?post="+campaign_id+"&action=edit"}}document.getElementsByTagName("html")[0].className+=" mailster-loading";window.mailster=parent.window.mailster||{};mailster=function(e,t,a,i){"use strict";e.editor=e.editor||{};e.editor.loaded=false;e.editor.$=e.editor.$||{};e.editor.$.html=t("html");e.editor.$.body=t("body");t(a).on("load",function(){e.editor.updateElements();e.editor.$.html.removeClass("mailster-loading");e.editor.$.body.on("click","a",function(e){e.preventDefault()}).on("click",function(t){e.modules.selected&&e.modules.selected.removeAttr("active")}).on("click","module",function(a){if("MODULE"==a.target.nodeName){var i=t(this);a.stopPropagation();if(e.modules.selected[0]!=i[0]){e.trigger("selectModule",i)}}}).on("click","button.addbutton",function(){var a=t(this).data(),i=decodeURIComponent(a.element.data("tmpl"))||'<a href="" editable label="Button"></a>';e.editbar.open({type:"btn",offset:a.offset,element:t(i).attr("tmpbutton","").appendTo(a.element),name:a.name});return false}).on("click","button.addrepeater",function(){var a=t(this).data();if("TH"==a.element[0].nodeName||"TD"==a.element[0].nodeName){var i=a.element.closest("table"),r=a.element.prevAll().length;for(var o=i[0].rows.length-1;o>=0;o--){t(i[0].rows[o].cells[r]).clone().insertAfter(i[0].rows[o].cells[r])}}else{a.element.clone().insertAfter(a.element)}e.trigger("save");e.trigger("refresh");return false}).on("click","button.removerepeater",function(){var a=t(this).data();if("TH"==a.element[0].nodeName||"TD"==a.element[0].nodeName){var i=a.element.closest("table"),r=a.element.prevAll().length;for(var o=i[0].rows.length-1;o>=0;o--){t(i[0].rows[o].cells[r]).remove()}}else{a.element.remove()}e.trigger("save");e.trigger("refresh");return false});if(!e.editor.loaded){e.editor.loaded=true;e.trigger("editorLoaded")}});e.editor.getFrameContent=function(){if(!e.editor.$.body.length){return false}var a=e.editor.$.body[0],i,r,o,n,l="";i=t("<div>"+a.innerHTML+"</div>");i.find(".mce-tinymce, .mce-widget, .mce-toolbar-grp, .mce-container, .screen-reader-text, .ui-helper-hidden-accessible, .wplink-autocomplete, modulebuttons, mailster, #mailster-editorimage-upload-button, button, .a11y-speak-intro-text").remove();i.find("single, multi, module, modules, buttons").removeAttr("contenteditable spellcheck id dir style class active");r=e.util.trim(i.html().replace(/\u200c/g,"&zwnj;").replace(/\u200d/g,"&zwj;"));o=a.attributes||[];n=o.length;if(n){while(n--){l=" "+o[n].name+'="'+e.util.trim(o[n].value)+'"'+l}}l=e.util.trim(l.replace(/(webkit |wp\-editor|mceContentBody|position: relative;|cursor: auto;|modal-open| spellcheck="(true|false)")/g,"").replace(/(class="(\s*)"|style="(\s*)")/g,""));return e.$.head.val()+"\n<body"+(l?" "+l:"")+">\n"+r+"\n</body>\n</html>"};e.editor.cleanup=function(){e.editor.$.document.find("#a11y-speak-assertive, #a11y-speak-polite, #droplr-chrome-extension-is-installed").remove()};e.editor.getStructure=function(a){var i=a.match(/([^]*)<body([^>]*)?>([^]*)<\/body>([^]*)/m);return{parts:i?i:["","","","<multi>"+a+"</multi>"],content:i?i[3]:"<multi>"+a+"</multi>",head:i?e.util.trim(i[1]):"",bodyattributes:i?t("<div"+(i[2]||"")+"></div>")[0].attributes:""}};e.editor.getContent=function(){return e.$.content.val()||e.editor.getFrameContent()};e.editor.setContent=function(t,a,i,r){var o=e.editor.getStructure(t),n=o.bodyattributes.length,l=e.editor.$.document.find("head"),d=l.find("link");e.$.head.val(o.head);if(!r){r=""}l[0].innerHTML=o.head.replace(/([^]*)<head([^>]*)?>([^]*)<\/head>([^]*)/m,"$3"+r);l.append(d);e.editor.$.body[0].innerHTML=o.content;if(n){while(n--){e.editor.$.body[0].setAttribute(o.bodyattributes[n].name,o.bodyattributes[n].value)}}e.$.content.val(t);if(typeof i=="undefined"||i===true){e.trigger("save")}setTimeout(function(){e.trigger("redraw")},100)};e.editor.getHeight=function(){return Math.max(500,e.editor.$.body.outerHeight())};e.editor.resize=function(){if(!e.editor.loaded)return false;setTimeout(function(){e.$.iframe.attr("height",e.editor.getHeight());e.trigger("resize")},50)};e.editor.colors=e.$.options.find(".colors").data();function r(){e.$.templateWrap.removeClass("load");e.trigger("iframeLoaded");o()}function o(){e.editor.$.document.find(".content.mailster-btn").remove();var a=null;if(!e.editor.$.document)return;e.editor.$.document.on("click.mailster","img[editable]",function(a){a.stopPropagation();var i=t(this),r=i.offset(),o=r.top+61,n=r.left,l=i.attr("label"),d="img";e.editbar.open({offset:r,type:d,name:l,element:i})}).on("click.mailster","module td[background],module th[background]",function(e){e.stopPropagation();a=true}).on("click.mailster","td[background], th[background]",function(i){i.stopPropagation();if(!a&&i.target!=this)return;a=null;var r=t(this),o=r.offset(),n=o.top+61,l=o.left,d=r.attr("label"),s="img";e.editbar.open({offset:o,type:s,name:d,element:r})}).on("click.mailster","a[editable]",function(a){a.stopPropagation();a.preventDefault();var i=t(this),r=i.offset(),o=r.top+40,n=r.left,l=i.attr("label"),d="btn";e.editbar.open({offset:r,type:d,name:l,element:i})});if(!mailsterdata.inline){e.editor.$.container.on("click.mailster","multi, single",function(a){a.stopPropagation();var i=t(this),r=i.offset(),o=r.top+40,n=r.left,l=i.attr("label"),d=i.prop("tagName").toLowerCase();e.editbar.open({offset:r,type:d,name:l,element:i})})}e.editor.cleanup()}e.events=e.events||[];e.events.push("refresh",e.editor.resize);e.events.push("editorLoaded",r,e.editor.resize);e.events.push("redraw",o);e.editor.$.body.find("div.modulebuttons").remove();e.isrtl?e.editor.$.html.attr("mailster-is-rtl",""):e.editor.$.html.removeAttr("mailster-is-rtl");return e}(mailster||{},jQuery,window,document);mailster=function(e,t,a,i){"use strict";var r,o=false,n=false;e.events=e.events||[];e.events.push("editorLoaded",function(){e.events.push("refresh",l,s,u);s();u();e.events.push("resize",m)&&m();e.events.push("selectModule",c);typeof mOxie!="undefined"&&e.events.push("refresh",f)&&f();typeof tinymce!="undefined"&&e.events.push("refresh",p)&&p()});t(i).ready(l);function l(){e.editor.$=e.editor.$||{};e.editor.$.document=t(i);e.editor.$.window=t(a);e.editor.$.html=t("html");e.editor.$.body=t("body");e.editor.$.container=t("modules");e.editor.$.modules=t("module");e.editor.$.images=t("img[editable]");e.editor.$.buttons=t("buttons");e.editor.$.repeatable=t("[repeatable]")}function d(){var a=t(mailsterdata.modules).add(e.editor.$.modules),i=0;if(!e.editor.$.modules.length){return}a=e.editor.$.modules;t.each(a,function(a){var r=t(this);if(r.is("module")&&!r.find("modulebuttons").length){var o=r.attr("label")||e.util.sprintf(e.l10n.campaigns.module,"#"+ ++i),n=mailsterdata.codeview?'<button class="mailster-btn codeview" title="'+e.l10n.campaigns.codeview+'"></button>':"",l=r.is("[auto]")?'<button class="mailster-btn auto" title="'+e.l10n.campaigns.auto+'"></button>':"";t("<modulebuttons>"+'<input class="modulelabel" type="text" value="'+o+'" placeholder="'+o+'" title="'+e.l10n.campaigns.module_label+'" tabindex="-1"><span>'+l+'<button class="mailster-btn duplicate" title="'+e.l10n.campaigns.duplicate_module+'"></button><button class="mailster-btn up" title="'+e.l10n.campaigns.move_module_up+'"></button><button class="mailster-btn down" title="'+e.l10n.campaigns.move_module_down+'"></button>'+n+'<button class="mailster-btn remove" title="'+e.l10n.campaigns.remove_module+'"></button></span></modulebuttons>').prependTo(r)}})}function s(){if(e.editor.$.container.data("sortable"))e.editor.$.container.sortable("destroy");if(e.editor.$.modules.length<2)return;e.editor.$.container.sortable({stop:function(t,a){t.stopPropagation();e.editor.$.container.removeClass("dragging");setTimeout(function(){e.trigger("refresh");e.trigger("save")},200)},start:function(t,a){t.stopPropagation();e.editor.$.container.addClass("dragging")},containment:"body",revert:100,axis:"y",placeholder:"sortable-placeholder",items:"> module",delay:20,distance:5,scroll:true,scrollSensitivity:10,forcePlaceholderSize:true,helper:"clone",zIndex:1e4})}function u(){if(e.editor.$.images.data("draggable"))e.editor.$.images.draggable("destroy");if(e.editor.$.images.data("droppable"))e.editor.$.images.droppable("destroy");e.editor.$.images.draggable({helper:"clone",scroll:true,scrollSensitivity:10,opacity:.7,zIndex:1e3,revert:"invalid",addClasses:false,create:function(e,a){t(e.target).removeClass("ui-draggable-handle")},start:function(){e.editor.$.body.addClass("ui-dragging")},stop:function(){e.editor.$.body.removeClass("ui-dragging");e.trigger("refresh")}}).droppable({addClasses:false,over:function(e,a){t(e.target).addClass("ui-drag-over")},out:function(e,a){t(e.target).removeClass("ui-drag-over")},drop:function(a,i){var r=t(i.draggable[0]),o=t(a.target),n,l,d,s;o.removeClass("ui-drag-over");if(!r.is("img")||!o.is("img"))return;n=o.attr("data-id")?parseInt(o.attr("data-id"),10):null;l=r.attr("data-id")?parseInt(r.attr("data-id"),10):null;d=r.data("crop");s=r.clone();r.addClass("mailster-loading");o.addClass("mailster-loading");e.util.getRealDimensions(r,function(t,i,d){e.util.getRealDimensions(o,function(u,m,c){if(a.altKey){r.removeClass("mailster-loading");o.removeClass("mailster-loading")}else if(n){e.util.ajax("create_image",{id:n,width:t,height:i,crop:r.data("crop")},function(e){r.removeAttr("src").attr({"data-id":n,title:o.attr("title"),alt:o.attr("alt"),src:e.data.image.url,width:Math.round(e.data.image.width/d),height:Math.round(e.data.image.height/d)}).data("id",n).removeClass("mailster-loading")},function(e,t,a){alert(t+" "+e.status+": "+a+"\n\nCheck the JS console for more info!")})}else{r.removeAttr("src").attr({"data-id":0,title:o.attr("title"),alt:o.attr("alt"),src:o.attr("src"),width:Math.round(t/d),height:Math.round(t/(u/m)/d)}).data("id",0).removeClass("mailster-loading")}if(l){e.util.ajax("create_image",{id:l,width:u,height:m,crop:o.data("crop")},function(t){o.removeAttr("src").attr({"data-id":l,title:r.attr("title"),alt:r.attr("alt"),src:t.data.image.url,width:Math.round(t.data.image.width/c),height:Math.round(t.data.image.height/c)}).data("id",l).removeClass("mailster-loading");e.trigger("refresh")},function(e,t,a){alert(t+" "+e.status+": "+a+"\n\nCheck the JS console for more info!")})}else{o.removeAttr("src").attr({"data-id":0,title:s.attr("title"),alt:s.attr("alt"),src:s.attr("src"),width:Math.round(u/c),height:Math.round(u/(t/i)/c)}).data("id",0).removeClass("mailster-loading")}if(!l&&!n)e.trigger("refresh")})})}})}function m(){if(e.editor.$.buttons){t.each(e.editor.$.buttons,function(){var a=t(this),i=a.attr("label"),r=this.getBoundingClientRect(),o=r.top+0,n=r.right+0,l,d;if(a.data("has-buttons"))return;l=t('<button class="addbutton mailster-btn mailster-btn-inline" title="'+e.l10n.campaigns.add_button+'"></button>').appendTo(a);l.data("offset",r).data("name",i);l.data("element",a);a.data("has-buttons",true);if(!(d=a.data("tmpl"))){if(a.find(".textbutton").length){d=a.find(".textbutton").last()}else if(a.find("img").length){d=a.find("a[editable]").last()}else{d=t('<a href="" editable label="Button"></a>')}d=t("<div/>").text(encodeURIComponent(d[0].outerHTML)).html()}a.attr("data-tmpl",d).data("tmpl",d)})}t("button.addrepeater, button.removerepeater").remove();if(e.editor.$.repeatable){t.each(e.editor.$.repeatable,function(){var a=t(this),i=a.closest("module"),r=a.attr("label"),o=i[0].getBoundingClientRect(),n=this.getBoundingClientRect(),l=n.top-o.top,d=n.left,s=n.top-o.top+18,u=n.left,m;if("TH"==this.nodeName||"TD"==this.nodeName){l=0;d=n.width-36;s=0;u=n.width-18}m=t('<button class="addrepeater mailster-btn mailster-btn-inline" title="'+e.l10n.campaigns.add_repeater+'"></button>').css({top:l,left:d}).appendTo(a);m.data("offset",n).data("name",r);m.data("element",a);m=t('<button class="removerepeater mailster-btn mailster-btn-inline" title="'+e.l10n.campaigns.remove_repeater+'"></button>').css({top:s,left:u}).appendTo(a);m.data("offset",n).data("name",r);m.data("element",a)})}}function c(t){if(!t.length){return}if(e.modules.selected){e.modules.selected.removeAttr("active")}e.modules.selected=t;e.modules.selected.attr("active",true)}function f(){t.each(e.editor.$.images,function(){var i=t(this),r;if(i.data("has-dropzone"))return;r=new mOxie.FileDrop({drop_zone:this});r.ondrop=function(o){if(e.modules.dragging)return;i.removeClass("ui-drag-over-file ui-drag-over-file-alt");var l=r.files.shift(),d=a.event&&event.altKey,s=[i.width(),i.height()],u=i.data("crop"),m=i.offset(),c=t('<upload><div class="mailster-upload-info"><div class="mailster-upload-info-bar"></div><div class="mailster-upload-info-text"></div></div></upload>'),f=c.find(".mailster-upload-info-bar"),p=c.find(".mailster-upload-info-text"),g=new mOxie.Image(l);g.onerror=function(t){alert(e.l10n.campaigns.unsupported_format)};g.onload=function(e){c.insertAfter(i);i.appendTo(c);l._element=i;l._altKey=d;l._crop=u;l._upload=c;l._preview=f;l._previewtext=p;l._dimensions=[g.width,g.height,g.width/g.height];g.downsize(s[0],s[1]);f.css({"background-image":"url("+g.getAsDataURL()+")","background-size":s[0]+"px "+(u?s[1]:s[0]/l._dimensions[2])+"px"});n.addFile(l)};g.load(l)};r.ondragenter=function(t){if(e.modules.dragging)return;i.addClass("ui-drag-over-file");if(a.event&&event.altKey)i.addClass("ui-drag-over-file-alt")};r.ondragleave=function(t){if(e.modules.dragging)return;i.removeClass("ui-drag-over-file ui-drag-over-file-alt")};r.onerror=function(t){if(e.modules.dragging)return;i.removeClass("ui-drag-over-file ui-drag-over-file-alt")};r.init();i.data("has-dropzone",true)});if(!n){t('<button id="mailster-editorimage-upload-button" />').hide().appendTo("mailster");n=new plupload.Uploader(mailsterdata.plupload);n.bind("Init",function(e){t(".moxie-shim").remove()});n.bind("FilesAdded",function(t,a){var i=a[0].getSource();e.util.getRealDimensions(i._element,function(e,a,r){t.settings.multipart_params.width=e;t.settings.multipart_params.height=a;t.settings.multipart_params.factor=r;t.settings.multipart_params.crop=i._crop;t.settings.multipart_params.altKey=i._altKey;t.refresh();t.start()})});n.bind("BeforeUpload",function(e,t){});n.bind("UploadFile",function(e,t){});n.bind("UploadProgress",function(e,t){var a=t.getSource();a._preview.width(t.percent+"%");a._previewtext.html(t.percent+"%")});n.bind("Error",function(e,t){var a=t.file.getSource();alert(t.message);a._element.insertAfter(a._upload);a._upload.remove()});n.bind("FileUploaded",function(t,a,i){var r=a.getSource(),o,n;try{i=JSON.parse(i.response);r._previewtext.html(e.l10n.campaigns.ready);r._element.on("load",function(){clearTimeout(o);r._preview.fadeOut(function(){r._element.insertAfter(r._upload);r._upload.remove();e.trigger("refresh")})});n=Math.round(r._element.width()/i.data.image.asp);r._element.attr({src:i.data.image.url,alt:i.data.name,height:n,"data-id":i.data.image.id||0}).data("id",i.data.image.id||0);r._preview.height(n);o=setTimeout(function(){r._preview.fadeOut(function(){r._element.insertAfter(r._upload);r._upload.remove();e.trigger("refresh")})},3e3)}catch(t){r._preview.addClass("error").find(".mailster-upload-info-text").html(e.l10n.campaigns.error);alert(e.l10n.campaigns.error_occurs+"\n"+t.message);r._preview.fadeOut(function(){r._element.insertAfter(r._upload);r._upload.remove()})}});n.bind("UploadComplete",function(e,t){});n.init()}}function p(){tinymce.init(t.extend(mailsterdata.tinymce.args,mailsterdata.tinymce.multi,{paste_preprocess:g,urlconverter_callback:v,setup:h}));tinymce.init(t.extend(mailsterdata.tinymce.args,mailsterdata.tinymce.single,{paste_preprocess:g,urlconverter_callback:v,setup:h}))}function g(e,t){var a=t.content,i="<a><br><i><em><strong><u><p><h1><h2><h3><h4><h5><h6><ul><ol><li>",r="",o=false,n=[],l=[],d="",s=0,u="",m="",c=function(e,t,a){return a.split(e).join(t)};if(i){l=i.match(/([a-zA-Z0-9]+)/gi)}a+="";n=a.match(/(<\/?[\S][^>]*>)/gi);for(r in n){if(isNaN(r)){continue}m=n[r].toString();o=false;for(u in l){d=l[u];s=-1;if(s!=0){s=m.toLowerCase().indexOf("<"+d+">")}if(s!=0){s=m.toLowerCase().indexOf("<"+d+" ")}if(s!=0){s=m.toLowerCase().indexOf("</"+d)}if(s==0){o=true;break}}if(!o){a=c(m,"",a)}}t.content=a;return a}function h(a){a.addButton("mailster_mce_button",{title:mailster_mce_button.l10n.tags.title,type:"menubutton",icon:"icon mailster-tags-icon",menu:t.map(mailster_mce_button.tags,function(e,i){return{text:e.name,menu:t.map(e.tags,function(e,t){return{text:e,onclick:function(){var e="",i;switch(t){case"webversion":case"unsub":case"forward":case"profile":e="link";case"homepage":if(i=a.selection.getContent({format:"text"})){a.insertContent('<a href="{'+t+e+'}">'+i+"</a>");break}default:a.insertContent("{"+t+"} ")}}}})}})});a.addButton("mailster_remove_element",{title:mailster_mce_button.l10n.remove.title,icon:"icon mailster-remove-icon",onclick:function(){a.targetElm.remove();a.remove();e.trigger("save")}});a.on("change",function(t){var a=this;clearTimeout(r);r=setTimeout(function(){var i=t.level.content,r=i.match(/rgb\((\d+), ?(\d+), ?(\d+)\)/g);if(r){for(var n=r.length-1;n>=0;n--){i=i.replace(r[n],e.util.rgb2hex(r[n]))}a.bodyElement.innerHTML=i}e.trigger("save");o=true},100)}).on("keyup",function(e){t(e.currentTarget).prop("spellcheck",true)}).on("click",function(i){var r=t(i.currentTarget).closest("module");if(e.modules.selected[0]!=r[0]){e.trigger("selectModule",r)}i.stopPropagation();a.focus()}).on("focus",function(t){t.stopPropagation();a.selection.select(a.getBody(),true);if(e.editor.$.container.data("uiSortable"))e.editor.$.container.sortable("destroy")}).on("blur",function(t){e.trigger("refresh")})}function v(e,t,a,i){if("_wp_link_placeholder"==e){return e}else if(/^https?:\/\/{.+}/g.test(e)){return e.replace(/^https?:\/\//,"")}else if(/^(([^<>()\[\]\.,;:\s@\"]+(\.[^<>()\[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})$/i.test(e)){return"mailto:"+e}return this.documentBaseURI.toAbsolute(e,mailsterdata.tinymce.remove_script_host)}e.editor.updateElements=l;e.editor.moduleButtons=d;e.events.push("editorLoaded",l,d);e.events.push("redraw",l,d);return e}(mailster||{},jQuery,window,document);parent.window.mailster=mailster;